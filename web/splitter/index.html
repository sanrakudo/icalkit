<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iCalKit Splitter - Split iCal Files</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ical.js@1.5.0/build/ical.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-indigo-50 via-white to-purple-50 min-h-screen">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useCallback, useMemo } = React;

        function ICalSplitter() {
            const [file, setFile] = useState(null);
            const [totalEvents, setTotalEvents] = useState(0);
            const [chunkSize, setChunkSize] = useState(500);
            const [isProcessing, setIsProcessing] = useState(false);
            const [isDragging, setIsDragging] = useState(false);
            const [events, setEvents] = useState([]);
            const [showEventList, setShowEventList] = useState(false);
            const [searchQuery, setSearchQuery] = useState('');

            const handleFileChange = useCallback((selectedFile) => {
                if (selectedFile && selectedFile.name.endsWith('.ics')) {
                    setFile(selectedFile);
                    
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const jcalData = ICAL.parse(e.target.result);
                            const comp = new ICAL.Component(jcalData);
                            const vevents = comp.getAllSubcomponents('vevent');
                            setTotalEvents(vevents.length);
                            
                            // Extract event details
                            const eventList = vevents.map((vevent, index) => {
                                const event = new ICAL.Event(vevent);
                                const summary = event.summary || '(„Çø„Ç§„Éà„É´„Å™„Åó)';
                                const description = event.description || '';
                                const location = event.location || '';
                                const startDate = event.startDate ? event.startDate.toJSDate() : null;
                                const endDate = event.endDate ? event.endDate.toJSDate() : null;
                                
                                return {
                                    id: index,
                                    summary,
                                    description,
                                    location,
                                    startDate,
                                    endDate
                                };
                            });
                            
                            // Sort by start date
                            eventList.sort((a, b) => {
                                if (!a.startDate) return 1;
                                if (!b.startDate) return -1;
                                return a.startDate - b.startDate;
                            });
                            
                            setEvents(eventList);
                        } catch (error) {
                            alert('iCal„Éï„Ç°„Ç§„É´„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
                            setFile(null);
                            setTotalEvents(0);
                            setEvents([]);
                        }
                    };
                    reader.readAsText(selectedFile);
                } else {
                    alert('.ics „Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                }
            }, []);

            const handleDragOver = useCallback((e) => {
                e.preventDefault();
                setIsDragging(true);
            }, []);

            const handleDragLeave = useCallback((e) => {
                e.preventDefault();
                setIsDragging(false);
            }, []);

            const handleDrop = useCallback((e) => {
                e.preventDefault();
                setIsDragging(false);
                const droppedFile = e.dataTransfer.files[0];
                handleFileChange(droppedFile);
            }, [handleFileChange]);

            const splitAndDownload = async () => {
                if (!file) return;

                setIsProcessing(true);

                try {
                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        try {
                            const jcalData = ICAL.parse(e.target.result);
                            const comp = new ICAL.Component(jcalData);
                            const vevents = comp.getAllSubcomponents('vevent');
                            
                            const numChunks = Math.ceil(vevents.length / chunkSize);
                            const zip = new JSZip();

                            for (let i = 0; i < numChunks; i++) {
                                const start = i * chunkSize;
                                const end = Math.min(start + chunkSize, vevents.length);
                                const chunk = vevents.slice(start, end);

                                // Êñ∞„Åó„ÅÑ„Ç´„É¨„É≥„ÉÄ„Éº„Ç≥„É≥„Éù„Éº„Éç„É≥„Éà„Çí‰ΩúÊàê
                                const newCal = new ICAL.Component(['vcalendar', [], []]);
                                
                                // ÂÖÉ„ÅÆ„Ç´„É¨„É≥„ÉÄ„Éº„ÅÆ„Éó„É≠„Éë„ÉÜ„Ç£„Çí„Ç≥„Éî„Éº
                                const originalProps = comp.getAllProperties();
                                originalProps.forEach(prop => {
                                    if (prop.name !== 'vevent') {
                                        newCal.addProperty(prop);
                                    }
                                });

                                // „Ç§„Éô„É≥„Éà„ÇíËøΩÂä†
                                chunk.forEach(vevent => {
                                    newCal.addSubcomponent(vevent);
                                });

                                const icsContent = newCal.toString();
                                const fileName = `calendar_part_${i + 1}_of_${numChunks}.ics`;
                                zip.file(fileName, icsContent);
                            }

                            const zipBlob = await zip.generateAsync({ type: 'blob' });
                            saveAs(zipBlob, `calendar_split_${numChunks}_files.zip`);
                        } catch (error) {
                            alert('ÂàÜÂâ≤Âá¶ÁêÜ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
                        } finally {
                            setIsProcessing(false);
                        }
                    };
                    reader.readAsText(file);
                } catch (error) {
                    alert('„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ' + error.message);
                    setIsProcessing(false);
                }
            };

            const numFiles = totalEvents > 0 ? Math.ceil(totalEvents / chunkSize) : 0;

            const filteredEvents = useMemo(() => {
                if (!searchQuery) return events;
                const query = searchQuery.toLowerCase();
                return events.filter(event => 
                    event.summary.toLowerCase().includes(query) ||
                    event.description.toLowerCase().includes(query) ||
                    event.location.toLowerCase().includes(query)
                );
            }, [events, searchQuery]);

            const formatDate = (date) => {
                if (!date) return '';
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                return `${year}/${month}/${day} ${hours}:${minutes}`;
            };

            return (
                <div className="container mx-auto px-4 py-12 max-w-3xl">
                    <div className="text-center mb-12">
                        <h1 className="text-5xl font-bold bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent mb-4">
                            iCalKit Splitter
                        </h1>
                        <p className="text-gray-600 text-lg">
                            Â§ß„Åç„Å™iCal„Éï„Ç°„Ç§„É´„ÇíÂàÜÂâ≤„Åó„Å¶„ÄÅGoogle„Ç´„É¨„É≥„ÉÄ„Éº„Å´Á∞°Âçò„Ç§„É≥„Éù„Éº„Éà
                        </p>
                    </div>

                    <div className="bg-white rounded-2xl shadow-xl p-8 mb-6">
                        <div
                            onDragOver={handleDragOver}
                            onDragLeave={handleDragLeave}
                            onDrop={handleDrop}
                            className={`border-3 border-dashed rounded-xl p-12 text-center transition-all duration-200 ${
                                isDragging
                                    ? 'border-indigo-500 bg-indigo-50'
                                    : 'border-gray-300 hover:border-indigo-400 hover:bg-gray-50'
                            }`}
                        >
                            <svg
                                className="mx-auto h-16 w-16 text-gray-400 mb-4"
                                stroke="currentColor"
                                fill="none"
                                viewBox="0 0 48 48"
                            >
                                <path
                                    d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02"
                                    strokeWidth={2}
                                    strokeLinecap="round"
                                    strokeLinejoin="round"
                                />
                            </svg>
                            <p className="text-xl font-semibold text-gray-700 mb-2">
                                iCal„Éï„Ç°„Ç§„É´„Çí„Éâ„É≠„ÉÉ„Éó
                            </p>
                            <p className="text-gray-500 mb-4">„Åæ„Åü„ÅØ</p>
                            <label className="inline-block">
                                <span className="px-6 py-3 bg-gradient-to-r from-indigo-500 to-purple-500 text-white rounded-lg cursor-pointer hover:from-indigo-600 hover:to-purple-600 transition-all shadow-md hover:shadow-lg font-medium">
                                    „Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû
                                </span>
                                <input
                                    type="file"
                                    accept=".ics"
                                    onChange={(e) => handleFileChange(e.target.files[0])}
                                    className="hidden"
                                />
                            </label>
                            {file && (
                                <div className="mt-6 p-4 bg-indigo-50 rounded-lg">
                                    <p className="text-indigo-800 font-medium">
                                        üìÑ {file.name}
                                    </p>
                                </div>
                            )}
                        </div>
                    </div>

                    {totalEvents > 0 && (
                        <div className="bg-white rounded-2xl shadow-xl p-8 mb-6">
                            <div className="mb-6">
                                <div className="flex items-center justify-between mb-4">
                                    <label className="text-lg font-semibold text-gray-700">
                                        1„Éï„Ç°„Ç§„É´„ÅÇ„Åü„Çä„ÅÆ„Ç§„Éô„É≥„ÉàÊï∞
                                    </label>
                                    <span className="text-3xl font-bold bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent">
                                        {chunkSize}
                                    </span>
                                </div>
                                <input
                                    type="range"
                                    min="50"
                                    max="1000"
                                    step="50"
                                    value={chunkSize}
                                    onChange={(e) => setChunkSize(Number(e.target.value))}
                                    className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-indigo-600"
                                />
                                <div className="flex justify-between text-sm text-gray-500 mt-2">
                                    <span>50</span>
                                    <span>500</span>
                                    <span>1000</span>
                                </div>
                            </div>

                            <div className="grid grid-cols-2 gap-4 mb-6">
                                <div className="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-xl p-6 text-center">
                                    <p className="text-gray-600 text-sm mb-2">Á∑è„Ç§„Éô„É≥„ÉàÊï∞</p>
                                    <p className="text-4xl font-bold text-indigo-600">
                                        {totalEvents.toLocaleString()}
                                    </p>
                                </div>
                                <div className="bg-gradient-to-br from-purple-50 to-pink-50 rounded-xl p-6 text-center">
                                    <p className="text-gray-600 text-sm mb-2">ÂàÜÂâ≤Âæå„ÅÆ„Éï„Ç°„Ç§„É´Êï∞</p>
                                    <p className="text-4xl font-bold text-purple-600">
                                        {numFiles.toLocaleString()}
                                    </p>
                                </div>
                            </div>

                            <button
                                onClick={splitAndDownload}
                                disabled={isProcessing}
                                className={`w-full py-4 px-6 rounded-xl font-bold text-lg transition-all shadow-lg ${
                                    isProcessing
                                        ? 'bg-gray-400 cursor-not-allowed'
                                        : 'bg-gradient-to-r from-indigo-500 to-purple-500 hover:from-indigo-600 hover:to-purple-600 text-white hover:shadow-xl transform hover:-translate-y-0.5'
                                }`}
                            >
                                {isProcessing ? (
                                    <span className="flex items-center justify-center">
                                        <svg className="animate-spin h-6 w-6 mr-3" viewBox="0 0 24 24">
                                            <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4" fill="none" />
                                            <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" />
                                        </svg>
                                        Âá¶ÁêÜ‰∏≠...
                                    </span>
                                ) : (
                                    `‚ú® ${numFiles}ÂÄã„ÅÆ„Éï„Ç°„Ç§„É´„Å´ÂàÜÂâ≤„Åó„Å¶„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ`
                                )}
                            </button>
                        </div>
                    )}

                    <div className="text-center text-sm text-gray-500 mt-8">
                        <p className="mb-2">üí° Google„Ç´„É¨„É≥„ÉÄ„Éº„ÅÆÊé®Â•®„Ç§„É≥„Éù„Éº„Éà„Çµ„Ç§„Ç∫„ÅØ500„Ç§„Éô„É≥„Éà‰ª•‰∏ã„Åß„Åô</p>
                        <p>ÂàÜÂâ≤„Åï„Çå„Åü„Éï„Ç°„Ç§„É´„ÅØ.zipÂΩ¢Âºè„Åß„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Åï„Çå„Åæ„Åô</p>
                    </div>

                    {totalEvents > 0 && (
                        <div className="bg-white rounded-2xl shadow-xl p-8 mt-6">
                            <button
                                onClick={() => setShowEventList(!showEventList)}
                                className="w-full flex items-center justify-between text-left mb-4"
                            >
                                <h2 className="text-2xl font-bold text-gray-800">
                                    üìÖ „Ç§„Éô„É≥„Éà‰∏ÄË¶ß
                                </h2>
                                <svg
                                    className={`w-6 h-6 text-gray-600 transition-transform ${showEventList ? 'rotate-180' : ''}`}
                                    fill="none"
                                    stroke="currentColor"
                                    viewBox="0 0 24 24"
                                >
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                                </svg>
                            </button>

                            {showEventList && (
                                <div className="space-y-4">
                                    <div className="mb-4">
                                        <input
                                            type="text"
                                            placeholder="üîç „Ç§„Éô„É≥„Éà„ÇíÊ§úÁ¥¢..."
                                            value={searchQuery}
                                            onChange={(e) => setSearchQuery(e.target.value)}
                                            className="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-indigo-500 focus:outline-none transition-colors"
                                        />
                                        <p className="text-sm text-gray-500 mt-2">
                                            {filteredEvents.length} / {totalEvents} „Ç§„Éô„É≥„Éà
                                        </p>
                                    </div>

                                    <div className="max-h-96 overflow-y-auto space-y-3 pr-2">
                                        {filteredEvents.map((event) => (
                                            <div
                                                key={event.id}
                                                className="border border-gray-200 rounded-lg p-4 hover:border-indigo-300 hover:shadow-md transition-all"
                                            >
                                                <h3 className="font-semibold text-gray-800 mb-2">
                                                    {event.summary}
                                                </h3>
                                                {event.startDate && (
                                                    <p className="text-sm text-gray-600 mb-1">
                                                        üïê {formatDate(event.startDate)}
                                                        {event.endDate && event.endDate.getTime() !== event.startDate.getTime() && 
                                                            ` ‚Üí ${formatDate(event.endDate)}`
                                                        }
                                                    </p>
                                                )}
                                                {event.location && (
                                                    <p className="text-sm text-gray-600 mb-1">
                                                        üìç {event.location}
                                                    </p>
                                                )}
                                                {event.description && (
                                                    <p className="text-sm text-gray-500 mt-2 line-clamp-2">
                                                        {event.description}
                                                    </p>
                                                )}
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ICalSplitter />);
    </script>
</body>
</html>
